# Руководство по устранению неполадок

## Проблемы с Render.com

### 1. Бэкенд отключается на время

**Симптомы:**
- Фронтенд падает при получении статуса
- Ошибки "Connection refused" или "Timeout"
- Health check не проходит

**Решения:**

#### A. Улучшенный Health Check
Добавлены дополнительные эндпоинты для мониторинга:
- `/` - корневой эндпоинт для проверки доступности
- `/health` - детальный health check с timestamp

#### B. Мониторинг состояния
Запустите скрипт мониторинга:
```bash
python monitor.py
```

#### C. Настройка Render.com
1. Увеличьте время таймаута в настройках сервиса
2. Настройте автоматический перезапуск при сбоях
3. Добавьте переменную окружения `BACKEND_URL` для мониторинга

### 2. Ошибки при вставке файла

**Симптомы:**
- "Неправильный токен"
- Ошибки авторизации
- Файлы не загружаются

**Решения:**

#### A. Проверка токена
1. Убедитесь, что токен не истек (30 минут)
2. Перелогиньтесь в системе
3. Проверьте правильность логина/пароля

#### B. Логирование ошибок
Все ошибки теперь логируются в `app.log`:
```bash
tail -f app.log
```

#### C. Очистка кэша
Если проблемы с Google Sheets:
```bash
curl -X POST /api/clear-cache
```

### 3. Проблемы с Google Sheets API

**Симптомы:**
- Ошибки "Quota exceeded"
- Проблемы с созданием листов
- Ошибки авторизации Google

**Решения:**

#### A. Настройка задержек
Переменные окружения для контроля API:
- `GOOGLE_API_DELAY=1.0` - задержка между запросами
- `MAX_RETRIES=3` - количество попыток
- `RETRY_DELAY=2.0` - задержка между попытками

#### B. Проверка credentials
1. Убедитесь, что `GOOGLE_CREDENTIALS` установлена
2. Или проверьте наличие `service-account.json`
3. Проверьте права доступа к таблицам

#### C. Очистка листов
Удалите листы с сегодняшней датой:
```bash
curl -X POST /api/clear-today-sheets
```

## Логирование

### Уровни логирования
- **INFO**: Обработка городов, успешные операции
- **WARNING**: Попытки повторных запросов, неверные токены
- **ERROR**: Критические ошибки, проблемы с API

### Файлы логов
- `app.log` - основной лог приложения
- `monitor.log` - лог мониторинга (если запущен)

### Просмотр логов
```bash
# Последние 100 строк
tail -n 100 app.log

# Мониторинг в реальном времени
tail -f app.log

# Поиск ошибок
grep "ERROR" app.log
```

## Мониторинг

### Запуск мониторинга
```bash
cd backend
python monitor.py
```

### Настройка переменных окружения
```bash
export BACKEND_URL="https://your-backend.onrender.com"
```

### Автоматический мониторинг
Добавьте в crontab для автоматической проверки:
```bash
*/5 * * * * cd /path/to/backend && python monitor.py
```

## Восстановление после сбоев

### 1. Перезапуск сервиса
```bash
# Остановка
pkill -f "uvicorn main:app"

# Запуск
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 2. Очистка временных файлов
```bash
rm -f temp_*.xls temp_*.xlsx
```

### 3. Сброс статусов задач
Перезапустите приложение для очистки `task_status`

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи: `tail -f app.log`
2. Запустите мониторинг: `python monitor.py`
3. Проверьте настройки Render.com
4. Убедитесь в правильности Google credentials
